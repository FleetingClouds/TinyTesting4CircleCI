# This is the configuration file for continuous integration of
# your project in CircleCi.
#
# The full reference is available at :
#             https://circleci.com/docs/configuration
#
machine:
  node:
    # Can't be certain that this build wlll work with all future versions: so specify.
    version: 0.10.33
  environment:
    # LOCAL_MODULES: ${HOME}
    # GLOBAL_MODULES: ${HOME}/nvm/v0.10.33/lib/
    NW_DIR: ${HOME}/${CIRCLE_PROJECT_REPONAME}/tests/nightwatch

dependencies:
  # Whatever is written to these directories during one build will be
  #    restored verbatim on every future build.
  cache_directories:
    - ~/.meteor
    - ~/node_modules
    - ~/nvm/v0.10.33/lib/node_modules
    - ~/nvm/v0.10.33/bin
  # Dependencies of the build run before CircleCI's inferred commands
  pre:
    # Check env vars
    - echo "${NW_DIR}"
    - echo "${CIRCLE_PROJECT_REPONAME}"
    # Install  Meteor
    - mkdir -p ~/.meteor
    # If Meteor is already cached, do not need to build it again.
    - if [ ! -e ~/.meteor/meteor ]; then curl https://install.meteor.com | /bin/sh; fi
    # Launch Meteor in background
    - ~/.meteor/meteor:
          background: true
    # Prepare Nightwatch dependencies
    - ./tests/nightwatch/bin/install-nightwatch-dependencies.sh
test:
  # Tests that replace CircleCI's inferred tests
  override:
    # - tests/tinyTests/test-all.sh
    - ${NW_DIR}/runTests.js | bunyan
